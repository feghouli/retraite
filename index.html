<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تسجيل المتقاعدين والأرامل في الرحلات 2025</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBnbQtyrGMltRuC9jhgu4OA9vaTXX5PXW8",
      authDomain: "omratouggourt.firebaseapp.com",
      projectId: "omratouggourt",
      storageBucket: "omratouggourt.firebasestorage.app",
      messagingSenderId: "414370554511",
      appId: "1:414370554511:web:c16fead011fa1e39e286fa",
      measurementId: "G-R5SER55HX5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const scriptURL = "https://script.google.com/macros/s/AKfycbxx2VsNZOkDnmAI_mh4ZJ8MMYkgbvWcCVF8qx4_9Ysf0c998TDRw15fw57LOi9ztlPwkA/exec";

    // ✅ التحقق من رقم الحساب
    window.validateNumber = input => {
      input.value = input.value.replace(/\D/g, '');
      if (input.value.length > 10) input.value = input.value.slice(0, 10);
    };

    window.checkAccount = async function() {
      const account = document.getElementById("account").value.trim();
      if (account.length < 7 || account.length > 10) {
        Swal.fire({ icon: 'warning', title: 'تنبيه', text: 'رقم الحساب يجب أن يحتوي على بين 7 و10 أرقام' });
        return;
      }

      Swal.fire({ title: 'جاري التحقق...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      const normalized = account.replace(/^0+/, "");

      try {
        const q = query(collection(db, "retraite"), where("account", "==", normalized));
        const snapshot = await getDocs(q);

        Swal.close();

        if (snapshot.empty) {
          Swal.fire({
            icon: "error",
            title: "❌ غير موجود",
            text: "رقم هذا الحساب غير موجود في قاعدة بيانات التقاعد",
            confirmButtonText: "🔁 إعادة المحاولة"
          }).then(() => location.reload());
          return;
        }

        const data = snapshot.docs[0].data();
        Swal.fire({
          icon: "success",
          title: "✅ الحساب موجود في قاعدة البيانات",
          html: `<b>رقم الحساب:</b> ${data.account}<br><b>الاسم الكامل:</b> ${data.name}`,
          confirmButtonText: "متابعة التسجيل"
        }).then(() => showForm(account, data.name));

      } catch (err) {
        console.error(err);
        Swal.fire("❌ خطأ", "فشل الاتصال بقاعدة البيانات", "error");
      }
    };

    // 🧾 نموذج التسجيل
    window.showForm = function(account, name) {
      const container = document.getElementById("mainContainer");
      container.innerHTML = `
        <h2>استمارة تسجيل المتقاعدين والأرامل</h2>

        <input type="text" id="accountField" value="${account}" readonly>
        <input type="text" id="nameField" value="${name}" readonly>

        <select id="statusField">
          <option value="">اختر الصفة</option>
          <option value="متقاعد(ة)">متقاعد(ة)</option>
          <option value="أرملة">أرملة</option>
        </select>

        <select id="daairaField" onchange="updateBaladiya()">
          <option value="">اختر دائرة الإقامة</option>
          <option value="توقرت">توقرت</option>
          <option value="تماسين">تماسين</option>
          <option value="المقارين">المقارين</option>
          <option value="الحجيرة">الحجيرة</option>
          <option value="الطيبات">الطيبات</option>
        </select>

        <select id="baladiyaField">
          <option value="">اختر بلدية الإقامة</option>
        </select>

        <select id="tripField">
          <option value="">اختر الرحلة</option>
          <option value="مصر">مصر</option>
          <option value="قالمة">قالمة</option>
          <option value="سطيف">سطيف</option>
          <option value="تمنراست">تمنراست</option>
        </select>

        <input type="text" id="phoneField" placeholder="رقم الهاتف (10 أرقام)" oninput="validatePhone(this)">
        <button id="submitBtn" onclick="submitForm()">تسجيل</button>
      `;

      window.baladiyaMap = {
        "توقرت": ["توقرت", "النزلة", "تبسبست", "الزاوية العابدية"],
        "تماسين": ["تماسين", "بلدة عمر"],
        "المقارين": ["المقارين", "سيدي سليمان"],
        "الحجيرة": ["الحجيرة", "العالية"],
        "الطيبات": ["الطيبات", "المنقر", "ابن ناصر"]
      };
    };

    window.updateBaladiya = function() {
      const daaira = document.getElementById("daairaField").value;
      const baladiyaSelect = document.getElementById("baladiyaField");
      baladiyaSelect.innerHTML = '<option value="">اختر بلدية الإقامة</option>';
      if (daaira && window.baladiyaMap[daaira]) {
        window.baladiyaMap[daaira].forEach(b => {
          const option = document.createElement("option");
          option.value = b; option.text = b;
          baladiyaSelect.add(option);
        });
      }
    };

    window.validatePhone = function(input) {
      let value = input.value.replace(/\D/g, "");
      if (value.length > 10) value = value.slice(0, 10);
      let formatted = "";
      for (let i = 0; i < value.length; i += 2) {
        if (i > 0) formatted += " ";
        formatted += value.substring(i, i + 2);
      }
      input.value = formatted;
    };

    // 🚀 إرسال البيانات إلى Google Sheets
    window.submitForm = async function() {
      const account = document.getElementById("accountField").value;
      const name = document.getElementById("nameField").value;
      const status = document.getElementById("statusField").value.trim();
      const daaira = document.getElementById("daairaField").value.trim();
      const baladiya = document.getElementById("baladiyaField").value.trim();
      const trip = document.getElementById("tripField").value.trim();
      const phone = document.getElementById("phoneField").value.trim();

      if (!status || !daaira || !baladiya || !trip || phone.replace(/\s/g, '').length !== 10) {
        Swal.fire("⚠️ تنبيه", "يرجى ملء جميع الحقول بشكل صحيح", "warning");
        return;
      }

      Swal.fire({ title: 'جاري التسجيل...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      const params = new URLSearchParams();
      params.append("action", "register");
      params.append("account", account);
      params.append("name", name);
      params.append("status", status);
      params.append("daaira", daaira);
      params.append("baladiya", baladiya);
      params.append("trip", trip);
      params.append("phone", phone);

      try {
        const res = await fetch(scriptURL, { method: "POST", body: params });
        const data = await res.json();

        Swal.close();

        // ✅ حالة التسجيل الجديد مع زر تحميل الوصل
        if (data.result === "success") {
          Swal.fire({
            title: "✅ تم التسجيل بنجاح",
            icon: "success",
            showCancelButton: true,
            confirmButtonText: "📄 تحميل وصل التسجيل",
            cancelButtonText: "🔙 إغلاق"
          }).then(result => {
            if (result.isConfirmed) {
              window.location.href = `https://feghouli.github.io/dawnload_recip_retraite/?empId=${accountNumber}`;

            } else {
              location.reload();
            }
          });
        } 
        // ⚠️ حالة مسجل مسبقًا
        else if (data.result === "exists") {
          const d = data.data;
          Swal.fire({
            title: "⚠️ الحساب مسجل مسبقًا",
            html: `<b>رقم الحساب:</b> ${d.account}<br>
                   <b>الاسم الكامل:</b> ${d.name}<br>
                   <b>الصفة:</b> ${d.status}<br>
                   <b>دائرة الإقامة:</b> ${d.daaira}<br>
                   <b>بلدية الإقامة:</b> ${d.baladiya}<br>
                   <b>الرحلة المختارة:</b> ${d.trip}<br>
                   <b>رقم الهاتف:</b> ${d.phone}`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "📄 تحميل وصل التسجيل",
            cancelButtonText: "🔙 إغلاق"
          }).then(result => {
            if (result.isConfirmed) {
              window.open(`https://feghouli.github.io/dawnload_recip_retraite/?empId=${d.account}`, "_blank");
            } else {
              location.reload();
            }
          });
        } 
        else {
          Swal.fire("❌ خطأ", "تعذر تسجيل البيانات", "error");
        }
      } catch (err) {
        console.error(err);
        Swal.fire("❌ خطأ", "فشل الاتصال بالخادم", "error");
      }
    };
  </script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; padding: 15px;
    }
    .container {
      background: white; padding: 35px 25px; border-radius: 18px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2); text-align: center;
      width: 100%; max-width: 500px;
      font-family: 'Cairo', sans-serif;
    }
    input, select, button, h2 {
      font-family: 'Cairo', sans-serif;
    }
    input, select {
      width: 100%; padding: 14px 18px; margin-bottom: 18px;
      border-radius: 10px; border: 2px solid #e0e0e0;
      font-size: 15px; text-align: center;
    }
    input:focus, select:focus { outline: none; border-color: #2575fc; }
    button {
      background: linear-gradient(45deg, #6a11cb, #2575fc);
      color: white; border: none; padding: 14px 0;
      border-radius: 10px; font-size: 15px; cursor: pointer;
      font-weight: 600; width: 100%;
    }
    #phoneField {
      direction: ltr;
      text-align: center;
    }

    .page-header {
      text-align: center;
      margin-bottom: 25px;
      font-family: "Cairo", sans-serif;
    }

    .page-header .header-logo {
      width: 160px;
      height: auto;
      display: block;
      margin: 0 auto 15px auto;
      filter: contrast(1.05) brightness(1.1);
      animation: pulseLogo 2.5s ease-in-out infinite;
    }

    @keyframes pulseLogo {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .gradient-title {
      font-family: "Cairo", sans-serif;
      font-size: 24px;
      font-weight: 600;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
      position: relative;
      margin-top: 20px;
      margin-bottom: 15px;
      display: inline-block;
    }

    .gradient-title::after {
      content: "";
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      border-radius: 2px;
    }
  </style>
</head>

<body>
  <div class="container" id="mainContainer">
    <div class="page-header">
      <img src="https://lh3.googleusercontent.com/d/1AOSzlvuRb-fAO0bqvo412HcHTfpRAX15" alt="شعار اللجنة" class="header-logo">
      <div class="header-text">
        الجمهورية الجزائرية الديمقراطية الشعبية<br>
        وزارة التربية الوطنية<br>
        اللجنة الوطنية للخدمات الاجتماعية لعمال التربية<br>
        اللجنة الولائية للخدمات الاجتماعية لعمال التربية لولاية توقرت
      </div>
    </div>

    <h2 class="gradient-title">بوابة تسجيل المتقاعدين و الأرامل في الرحلات</h2>
    <input type="text" id="account" placeholder="أدخل رقم الحساب الجاري" oninput="validateNumber(this)">
    <button onclick="checkAccount()">تحقق من رقم الحساب</button>
  </div>
</body>
</html>


