<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø§Ø¹Ø¯ÙŠÙ† ÙˆØ§Ù„Ø£Ø±Ø§Ù…Ù„ ÙÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª 2025</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; padding: 15px;
    }
    .container {
      background: white; padding: 35px 25px; border-radius: 18px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2); text-align: center;
      width: 100%; max-width: 400px;
    }
    input, select, button, h2 { font-family: 'Cairo', sans-serif; }
    input, select {
      width: 100%; padding: 14px 18px; margin-bottom: 18px;
      border-radius: 10px; border: 2px solid #e0e0e0;
      font-size: 15px; text-align: center;
    }
    button {
      background: linear-gradient(45deg, #6a11cb, #2575fc);
      color: white; border: none; padding: 14px 0;
      border-radius: 10px; font-size: 15px; cursor: pointer;
      font-weight: 600; width: 100%;
    }
    #phoneField { direction: ltr; text-align: center; }
  </style>
</head>

<body>
  <div class="container" id="mainContainer">
    <h2>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø§Ø±ÙŠ</h2>
    <input type="text" id="account" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø§Ø±ÙŠ" oninput="validateNumber(this)">
    <button onclick="checkAccount()">ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBnbQtyrGMltRuC9jhgu4OA9vaTXX5PXW8",
      authDomain: "omratouggourt.firebaseapp.com",
      projectId: "omratouggourt",
      storageBucket: "omratouggourt.firebasestorage.app",
      messagingSenderId: "414370554511",
      appId: "1:414370554511:web:c16fead011fa1e39e286fa",
      measurementId: "G-R5SER55HX5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const scriptURL = "https://script.google.com/macros/s/AKfycbxx2VsNZOkDnmAI_mh4ZJ8MMYkgbvWcCVF8qx4_9Ysf0c998TDRw15fw57LOi9ztlPwkA/exec";

    window.validateNumber = input => {
      input.value = input.value.replace(/\D/g, '');
      if (input.value.length > 10) input.value = input.value.slice(0, 10);
    };

    window.checkAccount = async function() {
      const account = document.getElementById("account").value.trim();
      if (account.length < 7 || account.length > 10) {
        Swal.fire({ icon: 'warning', title: 'ØªÙ†Ø¨ÙŠÙ‡', text: 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠÙ† 7 Ùˆ10 Ø£Ø±Ù‚Ø§Ù…' });
        return;
      }

      Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      const normalized = account.replace(/^0+/, "");
      try {
        const q = query(collection(db, "retraite"), where("account", "==", normalized));
        const snapshot = await getDocs(q);

        Swal.close();

        if (snapshot.empty) {
          Swal.fire({
            icon: "error",
            title: "âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯",
            text: "Ø±Ù‚Ù… Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø¹Ø¯",
            confirmButtonText: "ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©"
          }).then(() => location.reload());
          return;
        }

        const data = snapshot.docs[0].data();
        Swal.fire({
          icon: "success",
          title: "âœ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
          html: `<b>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:</b> ${data.account}<br><b>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</b> ${data.name}`,
          confirmButtonText: "Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„"
        }).then(() => showForm(account, data.name));
      } catch (err) {
        Swal.fire("âŒ Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
      }
    };

    window.showForm = function(account, name) {
      const container = document.getElementById("mainContainer");
      container.innerHTML = `
        <h2>Ø§Ø³ØªÙ…Ø§Ø±Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø§Ø¹Ø¯ÙŠÙ† ÙˆØ§Ù„Ø£Ø±Ø§Ù…Ù„</h2>
        <input type="text" id="accountField" value="${account}" readonly>
        <input type="text" id="nameField" value="${name}" readonly>
        <select id="statusField">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙØ©</option>
          <option value="Ù…ØªÙ‚Ø§Ø¹Ø¯(Ø©)">Ù…ØªÙ‚Ø§Ø¹Ø¯(Ø©)</option>
          <option value="Ø£Ø±Ù…Ù„Ø©">Ø£Ø±Ù…Ù„Ø©</option>
        </select>
        <select id="daairaField" onchange="updateBaladiya()">
          <option value="">Ø§Ø®ØªØ± Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</option>
          <option value="ØªÙˆÙ‚Ø±Øª">ØªÙˆÙ‚Ø±Øª</option>
          <option value="ØªÙ…Ø§Ø³ÙŠÙ†">ØªÙ…Ø§Ø³ÙŠÙ†</option>
          <option value="Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†">Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†</option>
          <option value="Ø§Ù„Ø­Ø¬ÙŠØ±Ø©">Ø§Ù„Ø­Ø¬ÙŠØ±Ø©</option>
          <option value="Ø§Ù„Ø·ÙŠØ¨Ø§Øª">Ø§Ù„Ø·ÙŠØ¨Ø§Øª</option>
        </select>
        <select id="baladiyaField"><option value="">Ø§Ø®ØªØ± Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</option></select>
        <select id="tripField">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø±Ø­Ù„Ø©</option>
          <option value="Ù…ØµØ±">Ù…ØµØ±</option>
          <option value="Ù‚Ø§Ù„Ù…Ø©">Ù‚Ø§Ù„Ù…Ø©</option>
          <option value="Ø³Ø·ÙŠÙ">Ø³Ø·ÙŠÙ</option>
          <option value="ØªÙ…Ù†Ø±Ø§Ø³Øª">ØªÙ…Ù†Ø±Ø§Ø³Øª</option>
        </select>
        <input type="text" id="phoneField" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (10 Ø£Ø±Ù‚Ø§Ù…)" oninput="validatePhone(this)">
        <button id="submitBtn" onclick="submitForm()">ØªØ³Ø¬ÙŠÙ„</button>
      `;

      window.baladiyaMap = {
        "ØªÙˆÙ‚Ø±Øª": ["ØªÙˆÙ‚Ø±Øª", "Ø§Ù„Ù†Ø²Ù„Ø©", "ØªØ¨Ø³Ø¨Ø³Øª", "Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ø¨Ø¯ÙŠØ©"],
        "ØªÙ…Ø§Ø³ÙŠÙ†": ["ØªÙ…Ø§Ø³ÙŠÙ†", "Ø¨Ù„Ø¯Ø© Ø¹Ù…Ø±"],
        "Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†": ["Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†", "Ø³ÙŠØ¯ÙŠ Ø³Ù„ÙŠÙ…Ø§Ù†"],
        "Ø§Ù„Ø­Ø¬ÙŠØ±Ø©": ["Ø§Ù„Ø­Ø¬ÙŠØ±Ø©", "Ø§Ù„Ø¹Ø§Ù„ÙŠØ©"],
        "Ø§Ù„Ø·ÙŠØ¨Ø§Øª": ["Ø§Ù„Ø·ÙŠØ¨Ø§Øª", "Ø§Ù„Ù…Ù†Ù‚Ø±", "Ø§Ø¨Ù† Ù†Ø§ØµØ±"]
      };
    };

    window.updateBaladiya = function() {
      const daaira = document.getElementById("daairaField").value;
      const baladiyaSelect = document.getElementById("baladiyaField");
      baladiyaSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</option>';
      if (daaira && window.baladiyaMap[daaira]) {
        window.baladiyaMap[daaira].forEach(b => {
          const option = document.createElement("option");
          option.value = b; option.text = b;
          baladiyaSelect.add(option);
        });
      }
    };

    window.validatePhone = input => {
      let value = input.value.replace(/\D/g, "");
      if (value.length > 10) value = value.slice(0, 10);
      let formatted = "";
      for (let i = 0; i < value.length; i += 2) {
        if (i > 0) formatted += " ";
        formatted += value.substring(i, i + 2);
      }
      input.value = formatted;
    };

    window.submitForm = async function() {
      const account = document.getElementById("accountField").value;
      const name = document.getElementById("nameField").value;
      const status = document.getElementById("statusField").value.trim();
      const daaira = document.getElementById("daairaField").value.trim();
      const baladiya = document.getElementById("baladiyaField").value.trim();
      const trip = document.getElementById("tripField").value.trim();
      const phone = document.getElementById("phoneField").value.trim();

      if (!status || !daaira || !baladiya || !trip || phone.replace(/\s/g, '').length !== 10) {
        Swal.fire("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­", "warning");
        return;
      }

      Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      const params = new URLSearchParams();
      params.append("action", "register");
      params.append("account", account);
      params.append("name", name);
      params.append("status", status);
      params.append("daaira", daaira);
      params.append("baladiya", baladiya);
      params.append("trip", trip);
      params.append("phone", phone);

      try {
        const res = await fetch(scriptURL, { method: "POST", body: params });
        const data = await res.json();

        Swal.close();

        if (data.result === "success") {
          Swal.fire({
            icon: "success",
            title: "âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­",
            text: "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ù…ÙŠÙ„ ÙˆØµÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„",
            confirmButtonText: "Ù…ÙˆØ§ÙÙ‚"
          }).then(() => {
            document.querySelectorAll("input, select").forEach(el => el.disabled = true);
            const btn = document.getElementById("submitBtn");
            btn.innerHTML = "ğŸ“„ ØªØ­Ù…ÙŠÙ„ ÙˆØµÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
            btn.onclick = () => generatePDF({ account, name, status, daaira, baladiya, trip, phone });

            const homeBtn = document.createElement("button");
            homeBtn.textContent = "ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©";
            homeBtn.style.cssText =
              "margin-top:15px;padding:12px 24px;font-size:16px;background:#6a11cb;color:#fff;border:none;border-radius:10px;cursor:pointer;width:100%;";
            homeBtn.onclick = () => location.reload();
            btn.insertAdjacentElement("afterend", homeBtn);
          });
        } else if (data.result === "exists") {
          const d = data.data;
          Swal.fire({
            title: "âš ï¸ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§",
            html: `<b>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:</b> ${d.account}<br>
                   <b>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</b> ${d.name}<br>
                   <b>Ø§Ù„ØµÙØ©:</b> ${d.status}<br>
                   <b>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©:</b> ${d.daaira}<br>
                   <b>Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©:</b> ${d.baladiya}<br>
                   <b>Ø§Ù„Ø±Ø­Ù„Ø©:</b> ${d.trip}<br>
                   <b>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</b> ${d.phone}`,
            icon: "warning",
            confirmButtonText: "Ø±Ø¬ÙˆØ¹"
          }).then(() => location.reload());
        } else {
          Swal.fire("âŒ Ø®Ø·Ø£", "ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
        }
      } catch (err) {
        Swal.fire("âŒ Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…", "error");
      }
    };

    // âœ… ØªÙˆÙ„ÙŠØ¯ ÙˆØµÙ„ PDF Ù…Ø¹ Ø®Ø· Ù…Ø­Ù„ÙŠ
    window.generatePDF = async ({ account, name, status, daaira, baladiya, trip, phone }) => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

      try {
        const fontUrl = "./fonts/Amiri-Regular.ttf";
        const response = await fetch(fontUrl);
        const buffer = await response.arrayBuffer();
        const fontBase64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));

        doc.addFileToVFS("Amiri-Regular.ttf", fontBase64);
        doc.addFont("Amiri-Regular.ttf", "Amiri", "normal");
        doc.setFont("Amiri");

        doc.setFontSize(18);
        doc.text("ÙˆØµÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„", 105, 25, { align: "center" });

        doc.setFontSize(14);
        const lines = [
          `Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: ${account}`,
          `Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„: ${name}`,
          `Ø§Ù„ØµÙØ©: ${status}`,
          `Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©: ${daaira}`,
          `Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©: ${baladiya}`,
          `Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: ${trip}`,
          `Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${phone}`,
          `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${new Date().toLocaleDateString("ar-DZ")}`
        ];

        let y = 50;
        lines.forEach(line => {
          const textWidth = doc.getTextWidth(line);
          doc.text(line, 200 - textWidth, y);
          y += 10;
        });

        doc.save(`ÙˆØµÙ„_${name}.pdf`);
      } catch (err) {
        Swal.fire("âš ï¸ Ø®Ø·Ø£", "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø±Ø¨ÙŠ", "warning");
        console.error(err);
      }
    };
  </script>
</body>
</html>
